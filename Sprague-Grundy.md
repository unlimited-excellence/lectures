# Лекція: Теорема Шпрага-Гранді (Sprague-Grundy)

Ця лекція присвячена ключовій теоремі в **Комбінаторній Теорії Ігор** (Combinatorial Game Theory), яка дозволяє звести аналіз будь-якої скінченної неупередженої гри до гри **Нім** (Nim).

---

## I. Неупереджені Ігри та Сума Ігор

### 1.1. Визначення Неупередженої Гри

**Неупереджена гра** (Impartial Game) — це гра двох гравців, у якій множина дозволених ходів із будь-якої позиції залежить лише від самої позиції, а **не від того, який гравець зараз ходить**.
* Ми припускаємо, що гра скінченна і без нічиїх (**нормальна гра**).
* **Правило Нормальної Гри (Normal Play Rule):** **Виграє** той гравець, який **зробив останній хід**.
* **Термінальна позиція** — позиція, з якої неможливо зробити жодного ходу. Вона є програшною (P-позицією).

### 1.2. Сума Ігор

**Сумою $G+H$** двох неупереджених ігор $G$ та $H$ називається гра, в якій гравець на своєму ходу:
1.  Обирає одну з ігор ($G$ або $H$).
2.  Робить у ній дозволений хід.

Гра $G+H$ закінчується, коли обидві її складові ($G$ і $H$) переходять у термінальні стани.
Скінченна сума $G_1 + G_2 + \dots + G_k$ визначається за звичайною індукцією.

> **Примітка:** Існує також клас **Misère Games**, де програє той, хто робить останній хід. Теорема Шпрага-Гранді стосується **нормальних ігор**.

---

## II. Числа Гранді (Німбери)

### 2.1. Визначення та Оператор $\text{mex}$

**Числом Гранді** (Grundy Number або **Німбером**) $\mathbf{\text{Gr}(G)}$ ігрової позиції $G$ називається невід'ємне ціле число, що визначається рекурсивно:

$$\text{Gr}(G) = \text{mex}\{\text{Gr}(G') : G' \text{ — позиція, досяжна за один хід з } G\}$$
$$\text{Gr}(\text{Термінальна позиція}) = 0$$

Оператор **$\text{mex}$** (Minimal Excludant) скінченної множини невід'ємних чисел $S$ — це **найменше невід'ємне число, яке не зустрічається в $S$**.
* **Приклади:** $\text{mex}\{0, 1, 3, 4, 7\} = 2$; $\text{mex}\{1, 2, 3\} = 0$; $\text{mex}\{0, 1, 2, \dots, n-1\} = n$.

### 2.2. Стратегія через Числа Гранді

У будь-якій неупередженій грі позиція $G$ є:
* **Виграшною (N-позицією),** якщо $\text{Gr}(G) \neq 0$.
* **Програшною (P-позицією),** якщо $\text{Gr}(G) = 0$.

---

## III. Теорема Шпрага-Гранді та Доведення

### 3.1. Формулювання Теореми

**Теорема Шпрага-Гранді (Sprague-Grundy Theorem):**

Для чисел Гранді позицій неупереджених ігор $G_1, G_2, \dots, G_k$ має місце:
$$\text{Gr}(G_1 + G_2 + \dots + G_k) = \text{Gr}(G_1) \oplus \text{Gr}(G_2) \oplus \dots \oplus \text{Gr}(G_k)$$
де символ $\oplus$ (або $\land$) позначає **побітове додавання за модулем два** (операція **XOR**).

> Таким чином, будь-яка неупереджена гра $G$ по суті є **еквівалентною** одній купці гри Нім розміром $\mathbf{n = \text{Gr}(G)}$.

### 3.2. Демонстрація: Теорема Бутона (Нім)

**Теорема Бутона (Bouton's Theorem):**
Позиція в Німі з $k$ купками розмірами $n_1, n_2, \dots, n_k$ є виграшною тоді й лише тоді, коли XOR-сума $\mathbf{n_1 \oplus n_2 \oplus \dots \oplus n_k \neq 0}$.

**Доведення за допомогою Шпрага-Гранді:**
1.  **Число Гранді для однієї купки:** Для Німа з $n$ камінцями ($\mathbf{\*n}$), доводиться, що $\text{Gr}(\*n) = \mathbf{n}$.
2.  **Застосування Теореми:** Гра Нім є сумою $k$ ігор $\*n_1 + \dots + \*n_k$.
    $$\text{Gr}(\*n_1 + \dots + \*n_k) = \text{Gr}(\*n_1) \oplus \dots \oplus \text{Gr}(\*n_k) = n_1 \oplus \dots \oplus n_k$$
3.  **Висновок:** Позиція є виграшною, якщо $\mathbf{n_1 \oplus \dots \oplus n_k \neq 0}$.

### 3.3. Доведення: Індукційний Перехід

Доведення ґрунтується на **структурній індукції** для суми двох ігор $G+H$.
Нехай $g = \text{Gr}(G)$ та $h = \text{Gr}(H)$.
Множина чисел Гранді позицій, досяжних з $G+H$, є $S := \{a \oplus h \mid a \in A\} \cup \{g \oplus b \mid b \in B\}$.
Мета: довести, що $\text{Gr}(G+H) = \text{mex}(S) = g \oplus h$.

### 3.4. Доведення: Теоретико-Числова Лема

**Лема:** $\text{mex}(\{a \oplus h \mid a \in A\} \cup \{g \oplus b \mid b \in B\}) = g \oplus h$.

**Схема Доведення:**
1.  $m = g \oplus h$ **не лежить** у $S$. (Інакше, $a = g \in A$, що суперечить $\text{mex}(A)=g$).
2.  Будь-яке $t < m$ **лежить** у $S$. (Доводиться бітовою індукцією, використовуючи найвищий біт $r$, де $g$ і $h$ відрізняються).
    * Якщо $r$-й біт $t=0$: $\mathbf{t \oplus h < g}$, отже $a=t \oplus h \in A$, і $t = a \oplus h \in S$.
    * Якщо $r$-й біт $t=1$: $\mathbf{t \oplus g < h}$, отже $b=t \oplus g \in B$, і $t = g \oplus b \in S$.
Таким чином, $\text{mex}(S) = g \oplus h$. QED.

---

## IV. Застосування та Аналіз

### 4.1. Задача про Розділення Купки Монет

**Умова:** Купка $n$ ділиться на $a+b$ де $a \ne b$. Визначити переможця.

**Рекурентна формула:**
$$\text{Gr}(G_n) = \text{mex}\{ \text{Gr}(G_a) \oplus \text{Gr}(G_b) \mid a + b = n, a \ne b, a, b \ge 1 \}$$

| $n$ | $\text{Gr}(G_n)$ |
| :--: | :---: |
| 1 | 0 |
| 2 | 0 |
| 3 | 1 |
| 4 | 0 |

**Код для Обчислення ($O(N^2)$):**
```cpp
// N_MAX - максимальний розмір купки
const int N_MAX = 5000; 
int gr[N_MAX + 1]; 
int aux[N_MAX + 1]; 

void solve_nim_split() {
    gr[0] = 0; gr[1] = 0; gr[2] = 0; 
    
    for (int n = 3; n <= N_MAX; n++) {
        for (int i = 0; i <= N_MAX; i++) 
            aux[i] = 0;
        
        for (int a = 1; a <= (n - 1) / 2; a++) {
            int nim_sum = gr[a] ^ gr[n - a];
            if (nim_sum <= N_MAX) {
                 aux[nim_sum] = 1;
            }
        }
        
        for (int i = 0; i <= N_MAX; i++) {
            if (aux[i] == 0) {
                gr[n] = i;
                break;
            }
        }
    }
}
// Якщо gr[x] = 0 — програшна (другий виграє), якщо gr[x] != 0 — виграшна (перший виграє).
```

### 4.2. Алгебраїчна Інтерпретація

Теорема Шпрага-Гранді визначає **гомоморфізм** $\text{Gr}: \text{Games} \to \text{Nimbers}$:
$$\text{Gr}(G + H) = \text{Gr}(G) \oplus \text{Gr}(H)$$
Де $\mathbf{\text{Games}}$ — моноїд ігор, а $\mathbf{\text{Nimbers}}$ — група $(\mathbb{N}_0, \oplus)$ (XOR).

Якщо ігри $G$ та $H$ еквівалентні ($G \sim H$) тоді й лише тоді, коли вони дають однаковий результат при додаванні до будь-якої іншої гри $X$, то:

**Кінцевий Висновок:**
$$\text{Games} / \sim \cong \text{Nimbers}$$
Моноїд класів еквівалентності ігор **канонічно ізоморфний** групі німберів, тобто кожна неупереджена гра еквівалентна Німу з розміром, рівним її числу Гранді.
